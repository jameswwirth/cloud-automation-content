formatVersion: 1
inputs:
  networkName:
    description: 'Network to connect the VEAB to'
    type: string
  hostname:
    description: 'Hostname of the VEBA appliance'
    type: string
  vcenterServer:
    description: 'The vCenter to Connect VEBA to'
    type: string
  vcenterUsername:
    description: 'vCenter Username'
    type: string
  vcenterPassword:
    description: 'vCenter Password'
    type: string
  vcenterDisableTLSVerification:
    description: Disable vCenter TLS
    type: string
    default: 'True'
  openfaasPassword:
    description: 'admin password for OpenFaaS UI'
    type: string
  deploymentImage:
    description: 'http address of the VEBA ova file'
    type: string
resources:
  VEBA:
    type: Cloud.vSphere.Machine
    metadata:
      layoutPosition:
        - 0
        - 0
    properties:
      imageRef: '${input.deploymentImage}'
      cpuCount: 4
      totalMemoryMB: 12288
      ovfProperties:
        - key: guestinfo.hostname
          value: '${input.hostname}'
        - key: guestinfo.ipaddress
          value: '${self.networks[0].address}'
        - key: guestinfo.netmask
          value: 23 (255.255.254.0)
        - key: guestinfo.gateway
          value: '${Cloud_vSphere_Network_1.gatewayAddress}'
        - key: guestinfo.dns
          value: '${substring(resource.Cloud_vSphere_Network_1.dnsServerAddresses, 1, length(resource.Cloud_vSphere_Network_1.dnsServerAddresses)-1)}'
        - key: guestinfo.domain"
          value: '${Cloud_vSphere_Network_1.domain}'
        - key: searchpath
          value: '${substring(resource.Cloud_vSphere_Network_1.dnsSearchDomains, 1, length(resource.Cloud_vSphere_Network_1.dnsSearchDomains)-1)}'
        - key: guestinfo.root_password
          value: VMware1!
        - key: guestinfo.vcenter_server
          value: '${input.vcenterServer}'
        - key: guestinfo.vcenter_username
          value: '${input.vcenterUsername}'
        - key: guestinfo.vcenter_password
          value: '${input.vcenterPassword}'
        - key: guestinfo.vcenter_disable_tls_verification
          value: '${input.vcenterDisableTLSVerification}'
        - key: guestinfo.openfaas_password
          value: '${input.openfaasPassword}'  
      networks:
        - name: '${resource.Cloud_vSphere_Network_1.name}'
          network: '${resource.Cloud_vSphere_Network_1.id}'
          assignment: static
      cloudConfig:
        runcmd:
          - systemctl start sshd
  Cloud_vSphere_Network_1:
    type: Cloud.Network
    metadata:
      layoutPosition:
        - 1
        - 0
    properties:
      name: '${input.networkName}'
      networkType: existing
      constraints:
        - tag: static-ip
